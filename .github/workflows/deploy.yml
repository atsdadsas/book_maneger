name: Auto Deploy to Dynabook

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug and Deploy
        run: |
          echo "--- Current Directory ---"
          pwd
          
          echo "--- Checking File Location ---"
          # app.pyがどこにあるか探す
          find . -name "app.py"
          
          echo "--- Attempting to Start ---"
          cd /home/nattu/book_maneger/bag
          
          # 以前のプロセスを確実に殺す（-9で強制終了）
          pkill -9 -f app.py || true
          
          # 起動して、もしエラーが出たら即座に表示させる
          # nohupを使わずに一度普通に実行してログに残るか試す
          python3 app.py > flask.log 2>&1 &
          
          # 3秒待ってからログの中身を表示
          sleep 3
          cat flask.log